# 系统整体架构设计

## 1. 系统概述

本系统是一个基于 React + LangGraph 的智能充电分析平台，支持用户注册登录、充电数据上传分析、RAG 知识管理、模型训练管理和系统日志管理等功能。

## 2. 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                    Frontend (React + TypeScript)                │
├─────────────────────────────────────────────────────────────────┤
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│ │  用户认证   │ │  充电分析   │ │   RAG管理   │ │   训练管理  │ │
│ │   组件      │ │   组件      │ │   组件      │ │   组件      │ │
│ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│                    Backend (LangGraph Python)                   │
├─────────────────────────────────────────────────────────────────┤
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│ │  充电分析   │ │   RAG系统   │ │   训练系统   │ │   日志系统  │ │
│ │   Agent     │ │ (ChromaDB)  │ │  (Trainer)  │ │ (Logger)    │ │
│ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ │
├─────────────────────────────────────────────────────────────────┤
│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│ │  用户管理   │ │   权限控制  │ │  文件存储   │ │   数据库    │ │
│ │   (Auth)    │ │   (RBAC)    │ │ (Storage)   │ │ (Database)  │ │
│ └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

## 3. 核心模块

### 3.1 前端模块 (React)
- **用户认证模块**: 登录/注册/JWT 令牌管理
- **充电分析模块**: 数据上传、可视化展示、AI 分析结果
- **RAG 管理模块**: 知识库管理、文档上传、检索测试
- **训练管理模块**: 数据集管理、训练任务、模型评估
- **日志管理模块**: 系统日志查看、过滤、导出

### 3.2 后端模块 (LangGraph)
- **充电分析 Agent**: 
  - 报文处理工具
  - 1.5B 流程控制模型
  - RAG 知识检索
  - 问题诊断和分析
  - 报告生成工具
- **RAG 系统**: 
  - ChromaDB 向量数据库
  - BGE-Base-ZH-v1.5 嵌入模型
  - 知识库构建和检索
- **训练系统**:
  - 模型训练管理器
  - 数据集管理器
  - 训练任务调度
  - 训练监控和评估
- **日志系统**:
  - 统一日志记录
  - 日志存储和检索
  - 日志分析和报告

### 3.3 数据存储层
- **关系数据库**: PostgreSQL (用户数据、训练数据、日志)
- **向量数据库**: ChromaDB (知识库、RAG 数据)
- **对象存储**: 本地文件系统/云存储 (文件上传、模型文件)
- **缓存**: Redis (会话缓存、训练状态缓存)

## 4. 核心技术栈

### 4.1 前端技术栈
- **框架**: React 18 + TypeScript
- **构建工具**: Vite
- **UI 组件**: Ant Design / Material-UI
- **状态管理**: Zustand / Redux Toolkit
- **路由**: React Router v6
- **HTTP 客户端**: Axios
- **实时通信**: WebSocket / Server-Sent Events
- **图表库**: Plotly.js / Chart.js
- **文件上传**: React-Dropzone

### 4.2 后端技术栈
- **框架**: FastAPI
- **Agent 框架**: LangChain + LangGraph
- **向量数据库**: ChromaDB
- **嵌入模型**: BGE-Base-ZH-v1.5
- **数据库 ORM**: SQLAlchemy + Alembic
- **身份认证**: JWT + FastAPI-Users
- **文件处理**: Pandas + NumPy
- **机器学习**: PyTorch + Transformers
- **日志**: Loguru + Structlog

### 4.3 部署和运维
- **反向代理**: Nginx
- **进程管理**: PM2 (后端) + serve (前端)
- **监控**: Prometheus + Grafana
- **日志聚合**: ELK Stack

## 5. 安全性设计

### 5.1 身份认证和授权
- **JWT Token**: 无状态令牌认证
- **角色权限控制 (RBAC)**:
  - 普通用户: 基础对话和充电分析
  - 管理员: + RAG管理、训练管理、日志管理
- **API 权限**: 基于角色的 API 访问控制

### 5.2 数据安全
- **数据加密**: 敏感数据加密存储
- **文件上传**: 文件类型和大小验证
- **SQL 注入防护**: 参数化查询
- **XSS 防护**: 输入验证和输出转义

### 5.3 系统安全
- **CORS 配置**: 严格的跨域访问控制
- **请求限流**: API 访问频率限制
- **输入验证**: 严格的参数验证
- **安全头**: HTTPS、CSP、HSTS 等

## 6. 可扩展性设计

### 6.1 模块化架构
- **Agent 插件化**: 新的分析 Agent 可热插拔
- **RAG 系统扩展**: 支持多种向量数据库
- **训练框架扩展**: 支持多种深度学习框架
- **存储后端扩展**: 支持多种存储方案

### 6.2 微服务准备
- **服务解耦**: 各模块间松耦合设计
- **API 网关**: 统一的 API 入口
- **服务发现**: 服务注册和发现机制
- **负载均衡**: 请求分发和负载均衡

### 6.3 水平扩展
- **无状态设计**: 支持多实例部署
- **缓存层**: 减少数据库访问压力
- **异步处理**: 长时间任务异步处理
- **消息队列**: 任务队列和消息中间件

## 7. 性能优化

### 7.1 前端优化
- **代码分割**: 按需加载组件
- **虚拟滚动**: 大数据列表渲染优化
- **缓存策略**: 浏览器缓存和状态缓存
- **图片优化**: 懒加载和压缩

### 7.2 后端优化
- **数据库优化**: 索引优化和查询优化
- **缓存策略**: Redis 缓存热点数据
- **异步处理**: 长时间任务异步执行
- **资源池**: 数据库连接池和线程池

## 8. 监控和运维

### 8.1 系统监控
- **应用性能监控**: APM 工具
- **系统资源监控**: CPU、内存、磁盘、网络
- **数据库监控**: 连接数、查询性能、慢查询
- **API 监控**: 接口响应时间、错误率

### 8.2 日志管理
- **结构化日志**: JSON 格式日志
- **日志聚合**: 集中式日志收集
- **日志分析**: 异常检测和告警
- **日志轮转**: 日志文件管理

### 8.3 告警机制
- **性能告警**: 响应时间、吞吐量告警
- **错误告警**: 系统异常和错误告警
- **资源告警**: 资源使用率告警
- **业务告警**: 关键业务指标告警